<% content_for :title, "Credit Note #{@credit_note.id}" %>

<div class="show-buttons">
  <% if @credit_note.created? %>
    <%= link_to edit_credit_note_path(@credit_note), class: "pure-button" do %>
      <span class="material-symbols-outlined">edit</span> Edit
    <% end %>

    <%= button_to send_credit_note_credit_note_path(@credit_note),
        method: :post,
        form: { data: { turbo_method: :post } },
        class: "pure-button button-success" do %>
      <span class="material-symbols-outlined">send</span> Send Credit Note
    <% end %>

    <%= render partial: 'shared/delete_confirmation', locals: { entity: @credit_note, button_size: "" } %>
  <% end %>

  <%= link_to "#", onclick: "window.print(); return false;", class: "pure-button pure-button-primary" do %>
    <span class="material-symbols-outlined">print</span> Print
  <% end %>
  <%= link_to invoices_path, class: "pure-button" do %>
    <span class="material-symbols-outlined">arrow_back</span> Back to Invoices
  <% end %>
</div>

<div class="invoice-container">
  <div class="invoice-content">
    <!-- Header Section -->
    <div class="invoice-header">
      <div class="business-info">
        <h2><%= Rails.application.credentials.org_details[:name] %></h2>
        <address>
          <%= Rails.application.credentials.org_details[:address1] %><br>
          <%= Rails.application.credentials.org_details[:address2] %><br>
          <%= Rails.application.credentials.org_details[:town] %><br>
          <%= Rails.application.credentials.org_details[:postcode] %><br>
          <%= Rails.application.credentials.org_details[:email] %>
        </address>
      </div>

      <div class="invoice-title">
        <h1>CREDIT NOTE</h1>
        <% if @credit_note.sent? %>
          <div class="invoice-status <%= @credit_note.status %>">
            Copy
          </div>
        <% end %>
      </div>
    </div>

    <!-- Credit Note Details Section -->
    <div class="invoice-details">
      <div class="client-info">
        <h3>Bill To:</h3>
        <% bill_to = @credit_note.payee || @credit_note.client %>
        <div class="client-name"><%= bill_to.name %></div>
        <address>
          <%= bill_to.address1 %><br>
          <% if bill_to.address2.present? %>
            <%= bill_to.address2 %><br>
          <% end %>
          <%= bill_to.town %><br>
          <%= bill_to.postcode %>
        </address>

        <% if @credit_note.payee.present? %>
          <div class="services-for">
            <h4>Services For:</h4>
            <div><%= @credit_note.client.name %></div>
          </div>
        <% end %>
      </div>

      <div class="invoice-info">
        <table>
          <tr>
            <th>Credit Note Number:</th>
            <td class="text-right"><%= @credit_note.id %></td>
          </tr>
          <tr>
            <th>Date:</th>
            <td class="text-right"><%= @credit_note.date.strftime('%d %b %Y') %></td>
          </tr>
          <tr>
            <th>Original Invoice:</th>
            <td class="text-right"><%= link_to @credit_note.invoice_id, invoice_path(@credit_note.invoice) %></td>
          </tr>
          <tr>
            <th>Status:</th>
            <td class="text-right">
              <span class="status-badge <%= @credit_note.status %>">
                <%= @credit_note.status.humanize %>
              </span>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Reason Section -->
    <div class="credit-note-reason">
      <h3>Reason for Credit Note:</h3>
      <p><%= @credit_note.reason %></p>
    </div>

    <!-- Credit Amount -->
    <div class="invoice-items">
      <table class="pure-table pure-table-bordered">
        <thead>
          <tr>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Credit against Invoice #<%= @credit_note.invoice_id %></td>
            <td class="text-right"><%= @credit_note.amount.format %></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td class="total-label">Total Credit:</td>
            <td class="text-right total-amount"><%= @credit_note.amount.format %></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Additional Text -->
    <% if @credit_note.text.present? %>
      <div class="invoice-notes">
        <h3>Additional Notes:</h3>
        <%= @credit_note.text %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .credit-note-reason {
    margin: 30px 0;
    padding: 20px;
    background-color: #fff9e6;
    border-left: 4px solid #f57c00;
  }

  .credit-note-reason h3 {
    margin-top: 0;
    color: #f57c00;
  }

  .credit-note-reason p {
    margin-bottom: 0;
    line-height: 1.6;
  }

  /* Reuse invoice styles */
  .invoice-container {
    max-width: 900px;
    margin: 30px auto;
    background: white;
    padding: 40px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .invoice-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 2px solid #333;
  }

  .business-info h2 {
    margin: 0 0 10px 0;
    color: #333;
  }

  .business-info address {
    font-style: normal;
    line-height: 1.6;
    color: #666;
  }

  .invoice-title {
    text-align: right;
  }

  .invoice-title h1 {
    margin: 0;
    font-size: 2.5em;
    color: #333;
  }

  .invoice-status {
    display: inline-block;
    padding: 8px 16px;
    margin-top: 10px;
    border-radius: 4px;
    font-weight: bold;
    text-transform: uppercase;
  }

  .invoice-status.sent {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }


  .invoice-details {
    display: flex;
    justify-content: space-between;
    margin-bottom: 40px;
  }

  .client-info h3,
  .services-for h4 {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 0.9em;
    text-transform: uppercase;
  }

  .client-name {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 5px;
  }

  .client-info address {
    font-style: normal;
    line-height: 1.6;
    color: #666;
  }

  .services-for {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
  }

  .invoice-info table {
    border-collapse: collapse;
  }

  .invoice-info th {
    text-align: right;
    padding: 5px 15px 5px 0;
    color: #666;
    font-weight: normal;
  }

  .invoice-info td {
    padding: 5px 0;
    font-weight: bold;
  }

  .invoice-items {
    margin-bottom: 40px;
  }

  .invoice-items .pure-table {
    width: 100%;
  }

  .invoice-items th,
  .invoice-items td {
    padding: 12px;
  }

  .invoice-items tfoot {
    font-weight: bold;
    background-color: #f7f7f7;
  }

  .total-label {
    text-align: right;
    font-size: 1.1em;
  }

  .total-amount {
    font-size: 1.2em;
    color: #2c5282;
  }

  .text-right {
    text-align: right;
  }

  .invoice-notes {
    margin-top: 30px;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 4px;
  }

  .invoice-notes h3 {
    margin-top: 0;
  }

  @media print {
    .show-buttons {
      display: none;
    }

    .invoice-container {
      box-shadow: none;
      padding: 0;
    }
  }

  .show-buttons {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
</style>

